<html>
<head>
    <meta charset="UTF-8">
    <title>话务条</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <script src="/ctibar.js"></script>
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/vue/2.6.14/vue.min.js"></script>
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/vConsole/3.12.1/vconsole.min.js"
            type="application/javascript"></script>
    <link rel="stylesheet"
          href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/element-ui/2.15.7/theme-chalk/index.min.css">
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/element-ui/2.15.7/index.min.js"></script>
    <script src="https://lf1-cdn-tos.bytegoofy.com/obj/iconpark/icons_14274_24.f20fe80492657f7818c76ceda219ec70.js"></script>
</head>
<body>
<div id="app">
    <div style="display:none;">
        <video id="audioView" autoplay></video>
    </div>

    <el-card class="my-softphone" :body-style="{padding: '0px'}">
        <div>
            <div class="status">
                <div v-if="!statusIsCall && !statusIsring">
                    <div v-show="!statusIsLogin" style="padding:10px 0 0 0px;">
                        <el-badge is-dot type="info" class="item"></el-badge>
                        分机未登录
                    </div>
                    <div v-show="statusIsLogin" style="padding:10px 0 0 0px;">
                        <el-badge is-dot type="success" class="item"></el-badge>
                        在线:<span class="number">{{ agentNo }}</span>
                    </div>
                </div>
                <div v-show="statusIsCall || statusIsring">
                    <div class="text">号码：<span class="number">{{ discallee }}</span></div>
                    <div class="text">时长：<span class="number">{{ callTime }}</span></div>
                </div>
            </div>

            <div class="btn">

                <div v-if="!statusIsCall">
                    <div v-if="!statusIsLogin" class="soft-function" @click="login">
                        <iconpark-icon name="checkIn-qianru"></iconpark-icon>
                        <div class="text">登录</div>
                    </div>
                    <div v-else class="soft-function" @click="logout">
                        <iconpark-icon name="checkOut-qianchu"></iconpark-icon>
                        <div class="text">登出</div>
                    </div>
                </div>

                <div v-if="statusIsCall" class="soft-function" :class="{disabled:!statusIsCall}">
                    <iconpark-icon name="transfer-zhuanjie"></iconpark-icon>
                    <div class="text">转接</div>
                </div>

                <div v-if="statusIsCall" :class="{disabled:!statusIsCall}">
                    <div v-if="!statusIsHold" class="soft-function" :class="{hold:!statusIsHold}" @click="hold">
                        <iconpark-icon name="keepHold-baochi"></iconpark-icon>
                        <div class="text">保持</div>
                    </div>
                    <div v-else class="soft-function" :class="{unhold:statusIsHold}" @click="unhold">
                        <iconpark-icon name="takeBack-jiehui"></iconpark-icon>
                        <div class="text">取回</div>
                    </div>
                </div>

                <div class="soft-function" :class="{disabled:!(statusIsring || statusIsCall)}" @click="hungup">
                    <iconpark-icon name="phone-off"></iconpark-icon>
                    <div class="text">挂断</div>
                </div>

                <div class="soft-function" :class="{disabled:!(statusIsring && 'inbound' === callDirection)}"
                     @click="answer">
                    <iconpark-icon name="phone-call"></iconpark-icon>
                    <div class="text">接听</div>
                </div>
            </div>
        </div>
    </el-card>

    <el-card v-show="statusIsLogin" class="config">
        <div>
            <el-input style="max-width: 80%" v-model="callPhoneNumber" placeholder="请输入外呼号码"></el-input>
            <el-button :disabled="!statusIsLogin || statusIsring || statusIsCall" type="primary"
                       icon="el-icon-phone" @click="makeCall"></el-button>
        </div>
        <div style="margin-top: 5px">
            <el-row>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber(1)">1</el-button>
                </el-col>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber(2)">2</el-button>
                </el-col>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber(3)">3</el-button>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber(4)">4</el-button>
                </el-col>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber(5)">5</el-button>
                </el-col>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber(6)">6</el-button>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber(7)">7</el-button>
                </el-col>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber(8)">8</el-button>
                </el-col>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber(9)">9</el-button>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber('*')">*</el-button>
                </el-col>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber(0)">0</el-button>
                </el-col>
                <el-col :span="8">
                    <el-button class="number-card-button" @click="pressNumber('#')">#</el-button>
                </el-col>
            </el-row>
        </div>
    </el-card>

    <el-tabs v-show="!statusIsLogin" class="config" type="border-card" v-model="activeTabName">
        <el-tab-pane label="参数设置" name="base">
            <div>
                <el-form ref="form" size="mini" label-position="left" label-width="80px">
                    <el-form-item label="sip服务器">
                        <el-input type="text" v-model="configuration.host" clearable/>
                    </el-form-item>
                    <el-form-item label="sip端口">
                        <el-input type="text" v-model="configuration.port" maxlength="5" clearable/>
                    </el-form-item>
                    <el-form-item label="ssl">
                        <el-switch v-model="configuration.proto"/>
                    </el-form-item>
                    <el-form-item label="domain">
                        <el-input type="text" v-model="configuration.domain" placeholder="选填" clearable/>
                    </el-form-item>
                    <el-form-item label="分机号">
                        <el-input type="text" v-model="configuration.extNo" clearable/>
                    </el-form-item>
                    <el-form-item label="分机密码">
                        <el-input type="password" v-model="configuration.extPwd" clearable show-password/>
                    </el-form-item>
                    <el-form-item label="打洞">
                        <el-radio-group v-model="configuration.stun.type">
                            <el-radio label="stun">stun</el-radio>
                            <el-radio label="turn">turn</el-radio>
                        </el-radio-group>
                    </el-form-item>
                    <el-form-item label="打洞host">
                        <el-input type="text" v-model="configuration.stun.host" clearable/>
                    </el-form-item>
                    <el-form-item v-if="configuration.stun.type==='turn'" label="username">
                        <el-input type="text" v-model="configuration.stun.username" clearable/>
                    </el-form-item>
                    <el-form-item v-if="configuration.stun.type==='turn'" label="password">
                        <el-input type="password" v-model="configuration.stun.password" clearable/>
                    </el-form-item>
                </el-form>
            </div>

            <div v-if="historyAccounts.length>0">
                <el-divider content-position="left">历史账号</el-divider>
                <div>
                    <el-table :data="historyAccounts" stripe style="width: 100%" size="mini" :show-header="false">
                        <el-table-column type="expand" width="15">
                            <template slot-scope="props">
                                <el-descriptions :column="1" size="mini" border>
                                    <el-descriptions-item label="服务器">{{ props.row.host }}:{{ props.row.port }}
                                    </el-descriptions-item>
                                    <el-descriptions-item label="domain">{{ props.row.domain }}</el-descriptions-item>
                                    <el-descriptions-item label="分机号">{{ props.row.extNo }}</el-descriptions-item>
                                    <el-descriptions-item label="密码">{{ props.row.extPwd }}</el-descriptions-item>
                                    <el-descriptions-item label="分享">{{shareAccount(props.row) }}
                                    </el-descriptions-item>
                                </el-descriptions>
                            </template>
                        </el-table-column>
                        <el-table-column label="SERVER">
                            <template slot-scope="scope">
                                <span style="font-size: 14px">{{ scope.row.extNo }}@{{
                                        scope.row.host
                                    }}:{{ scope.row.port }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column label="操作" width="136">
                            <template slot-scope="scope">
                                <el-button-group>
                                    <el-button size="mini" type="primary" :disabled="statusIsLogin"
                                               @click="useHistoryAccounts(scope.row)">使用
                                    </el-button>
                                    <el-button size="mini" type="danger" :disabled="statusIsLogin"
                                               @click="delHistoryAccounts(scope.$index)">删除
                                    </el-button>
                                </el-button-group>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
            </div>

        </el-tab-pane>

        <el-tab-pane label="调试信息" name="test">
            <el-divider content-position="left">设备列表</el-divider>
            <li v-for="(device,index) in mediaDevices">
                {{ device.kindText }}-{{ device.label }}
            </li>

            <el-divider content-position="left">麦克风测试</el-divider>

            <el-row>
                <el-col :span="16">
                    <el-progress :text-inside="true" :stroke-width="24" :percentage="testMicrophoneVolume"
                                 status="success"></el-progress>
                </el-col>
                <el-col :span="8">
                    <el-button size="mini" type="danger" round v-if="testMicrophoneOb"
                               @click="testMicrophoneHandelStop">结束测试
                    </el-button>
                    <el-button size="mini" type="success" round v-else @click="testMicrophoneHandelStart">开始测试
                    </el-button>
                </el-col>
            </el-row>

            <el-divider content-position="left">耳机测试</el-divider>
            <audio style="height: 30px" controls="" :loop="false" :autoplay="false"
                   src="https://web.sdk.qcloud.com/trtc/webrtc/assets/testspeak.mp3"></audio>


        </el-tab-pane>

    </el-tabs>

    <div id="footer">Power By <a target="_blank" href="https://github.com/xsdhy/softphone">xsdhy</a></div>
</div>
</body>
<script>
    //移动设备打开调试
    const device = navigator.userAgent
    if (device.indexOf('Android') > -1 || device.indexOf('iPhone') > -1 || device.indexOf('iPad') > -1 || device.indexOf('ios') > -1) {
        var vConsole = new VConsole();
    }

    new Vue({
        el: '#app',
        data() {
            return {
                activeTabName: "base",
                configuration: {
                    host: '',
                    port: '',
                    domain: '',
                    proto: true,
                    extNo: '',
                    extPwd: '',
                    stun: {
                        type: "stun",
                        host: "stun.xsdhy.com:3478",
                        username: '',
                        password: '',
                    },
                    autoRegister: false,
                    debug: false,
                    stateEventListener: this.stateEventListener
                },

                statusIsLogin: false,//是否登陆
                statusIsring: false,//是否在振铃中
                statusIsCall: false,//是否在拨打中
                statusIsHold: false,//是否在保持中

                callDirection: '',//呼叫方向

                agentNo: "",//分机号
                discaller: "",//主叫号码
                discallee: "",//被叫号码
                callPhoneNumber: "",//呼出号码

                durtime: 0,//计时器
                callTime: '00:00:00',//计时器-格式化
                callTimeInter: null,//计时器-定时器,

                historyAccounts: [],//历史账号列表
                lastAccount: "",//最后一次使用的账号配置

                networkSpeed: 0,//网速
                testMicrophoneOb: null,
                testMicrophoneVolume: 0,
                mediaDevices: null,

                loading: null,
            }
        },
        created() {
            console.log("v1.1.0");
            let account = this.getQueryVariable("u")

            this.initHistoryAccounts();
            this.callPhoneNumber = localStorage.getItem("callPhoneNumber")

            Ctibar.getMediaDeviceInfo().then((res) => {
                this.mediaDevices = res;
            });
        },
        methods: {
            login() {
                console.log("点击登陆按钮");
                if (this.configuration.host.length <= 3 || this.configuration.extNo.length <= 3 || this.configuration.extPwd.length <= 3) {
                    this.$message({
                        message: '请先在参数配置中输入账号信息',
                        type: 'warning'
                    });
                    return;
                }
                this.loading = this.$loading({text: '登录中...'});
                Ctibar.initSDK(this.configuration);
            },
            logout() {
                console.log("点击退出按钮")
                Ctibar.unregister()
            },
            answer() {
                console.log("点击应答按钮")
                Ctibar.answer()
            },
            hold() {
                console.log("点击保持按钮")
                Ctibar.hold()
            },
            unhold() {
                console.log("点击取消保持按钮")
                Ctibar.unhold()
            },
            makeCall() {
                console.log("点击拨打按钮")
                if (this.callPhoneNumber.length <= 2) {
                    this.$message({
                        message: '请输入要拨打的号码',
                        type: 'warning'
                    });
                    return
                }
                localStorage.setItem("callPhoneNumber", this.callPhoneNumber)
                this.discallee = this.callPhoneNumber
                Ctibar.makecall(this.callPhoneNumber.trim());
            },
            hungup() {
                console.log("点击挂断按钮");
                Ctibar.hangup()
            },
            //按键
            pressNumber(tone) {
                //在通话中就发送
                if (this.statusIsCall) {
                    Ctibar.sendDtmf(tone);
                } else {
                    this.callPhoneNumber = this.callPhoneNumber + "" + tone
                }
            },
            //事件回调
            stateEventListener(event, data) {
                console.log("收到事件", event, data);
                switch (event) {
                    case "REGISTERED":
                        this.statusIsLogin = true;
                        break;
                    case "UNREGISTERED":
                        this.statusIsLogin = false;
                        this.statusIsHold = false;
                        this.statusIsring = false;
                        this.statusIsCall = false;
                        break;
                    case "INCOMING_CALL":
                        this.playRingMedia()
                    case "OUTGOING_CALL":
                        console.log("来电", data.direction)
                        this.startTimerCall();
                        this.statusIsring = true;
                        this.callDirection = data.direction;
                        this.discaller = data.otherLegNumber;
                        this.discallee = this.agentNo;
                        break;
                    case "IN_CALL":
                        this.startTimerCall();
                        this.stopPlayRingMedia();
                        this.statusIsring = false;
                        this.statusIsCall = true;
                        this.statusIsHold = false;
                        break;
                    case "CALL_END":
                        this.stopTimerCall();
                        this.stopPlayRingMedia();
                        this.statusIsring = false;
                        this.statusIsCall = false;
                        this.statusIsHold = false;
                        break;
                    case "HOLD":
                        this.statusIsHold = true;
                        break;
                    case "UNHOLD":
                        this.statusIsHold = false;
                        break;
                    case "MUTE":
                        this.status_is_mute = true;
                        break;
                    case "UNMUTE":
                        this.status_is_mute = false;
                        break;
                    case "CONNECTED":
                        //已连接
                        this.loading.close();
                        this.saveHistoryAccounts()
                        this.agentNo = data.localAgent;
                        Ctibar.register()
                        break;
                    case "DISCONNECT":
                        console.log("DISCONNECT", data.msg)
                        break;
                    case "RECONNECT":
                        break;
                    case "REGISTER_FAILED":
                        this.loading.close();
                        this.$message.error(data.msg);
                        break;
                    default:
                        console.log("未处理事件")
                }
            },
            //启动计时器
            startTimerCall() {
                if (this.callTimeInter) {
                    clearInterval(this.callTimeInter);
                    this.callTime = "00:00:00";
                    this.durtime = 0;
                }
                this.callTimeInter = setInterval(() => {
                    this.timerCall();
                }, 1000)
            },
            //停止计时器
            stopTimerCall() {
                if (this.callTimeInter) {
                    clearInterval(this.callTimeInter);
                    this.callTime = "00:00:00";
                    this.durtime = 0;
                }
            },
            //计时器
            timerCall() {
                this.durtime++;
                var sec = this.durtime % 60;
                if (sec < 10) {
                    sec = "0" + sec;
                }
                var min = Math.floor((this.durtime % (60 * 60)) / 60);
                if (min < 10) {
                    min = "0" + min;
                }
                var hour = Math.floor(this.durtime / (60 * 60));
                if (hour < 10) {
                    hour = "0" + hour;
                }
                this.callTime = hour + ":" + min + ":" + sec
            },
            //播放挂机铃声
            playHangupMedia() {
                const _this = this;
                var hangupAudio = document.getElementById("hangupMediaAudioId")
                if (!hangupAudio) {
                    hangupAudio = document.createElement('audio');
                    hangupAudio.id = 'hangupMediaAudioId';
                    hangupAudio.hidden = true;
                    hangupAudio.src = './static/wav/hangup.wav'
                    document.body.appendChild(hangupAudio);
                }
                hangupAudio.play();
            },
            //播放来电振铃
            playRingMedia() {
                const _this = this;
                _this.stopPlayRingMedia();

                var ringAudio = document.getElementById("ringMediaAudioId")
                if (!ringAudio) {
                    ringAudio = document.createElement('audio');
                    ringAudio.id = 'ringMediaAudioId';
                    ringAudio.hidden = true;
                    ringAudio.src = './static/wav/ring.wav';
                    ringAudio.loop = 'loop';
                    document.body.appendChild(ringAudio);
                }
                ringAudio.play();
            },
            //停止播放来电振铃
            stopPlayRingMedia() {
                const _this = this;
                var ringAudio = document.getElementById("ringMediaAudioId");
                if (ringAudio) {
                    document.body.removeChild(ringAudio);
                }
            },
            //初始化历史账号，每次页面重新打开的时候执行
            initHistoryAccounts() {
                let historyAccounts = localStorage.getItem("historyAccounts")
                if (null != historyAccounts) {
                    this.historyAccounts = JSON.parse(historyAccounts)
                }
                if (this.historyAccounts.length <= 0) {
                    return;
                }

                //查看最后一次使用的账号是什么，若有则使用
                let lastAccount = localStorage.getItem("lastAccount")
                if (lastAccount === "") {
                    this.useHistoryAccounts(this.historyAccounts[0])
                    return
                }
                for (let index = 0; index < this.historyAccounts.length; index++) {
                    let id = this.historyAccounts[index].extNo + "@" + this.historyAccounts[index].host + ":" + this.historyAccounts[index].port;
                    if (lastAccount === id) {
                        this.useHistoryAccounts(this.historyAccounts[index])
                        break
                    }
                }
            },
            //使用历史账号
            useHistoryAccounts(item) {
                console.log("使用历史账号:", item)
                this.configuration.host = item.host;
                this.configuration.port = item.port;
                this.configuration.proto = item.proto;
                this.configuration.domain = item.domain;
                this.configuration.extNo = item.extNo;
                this.configuration.extPwd = item.extPwd;
                if (item.stun) {
                    this.configuration.stun = item.stun;
                }
            },
            //分享历史账号
            shareAccount(item) {
                return window.btoa(JSON.stringify(item))
            },
            //删除历史账号
            delHistoryAccounts(i) {
                if (this.historyAccounts.length > 0) {
                    this.historyAccounts.splice(i)
                    localStorage.setItem("historyAccounts", JSON.stringify(this.historyAccounts))
                }
            },
            //保存账号:登录成功的时候执行
            saveHistoryAccounts() {
                let is_add = true;
                for (let index = 0; index < this.historyAccounts.length; index++) {
                    if (this.historyAccounts[index].host === this.configuration.host && this.historyAccounts[index].extNo === this.configuration.extNo) {
                        is_add = false;
                        this.historyAccounts[index].host = this.configuration.host;
                        this.historyAccounts[index].port = this.configuration.port;
                        this.historyAccounts[index].proto = this.configuration.proto;
                        this.historyAccounts[index].domain = this.configuration.domain;
                        this.historyAccounts[index].extNo = this.configuration.extNo;
                        this.historyAccounts[index].extPwd = this.configuration.extPwd;
                        this.historyAccounts[index].stun = this.configuration.stun;
                    }
                }
                if (is_add) {
                    this.historyAccounts.push({
                        host: this.configuration.host,
                        port: this.configuration.port,
                        proto: this.configuration.proto,
                        domain: this.configuration.domain,
                        extNo: this.configuration.extNo,
                        extPwd: this.configuration.extPwd,
                        stun: this.configuration.stun,
                    })
                }
                localStorage.setItem("lastAccount", this.configuration.extNo + "@" + this.configuration.host + ":" + this.configuration.port)
                localStorage.setItem("historyAccounts", JSON.stringify(this.historyAccounts))
            },
            //麦克风音量检测-开始
            testMicrophoneHandelStart() {
                Ctibar.testMicrophone((volume) => {
                    this.testMicrophoneVolume = volume
                }).then((res) => {
                    this.testMicrophoneOb = res;
                });
            },
            //麦克风音量检测-结束
            testMicrophoneHandelStop() {
                if (this.testMicrophoneOb) {
                    this.testMicrophoneOb.yes();
                    this.testMicrophoneVolume = 0;
                    this.testMicrophoneOb = null;
                }
            },
            //网速检测
            testNetworkHandel() {
                //window.location.host+'/static/images/test-network-speed.jpg'
                Ctibar.testNetwork().then((networkSpeed) => {
                    this.networkSpeed = networkSpeed;
                    console.log("测速:", this.getFileSize(networkSpeed))
                });
            },
            //文件大小可视化
            getFileSize(size) {//把字节转换成正常文件大小
                if (!size) return "";
                size = size * 1024;
                var num = 1024.00; //byte
                if (size < num)
                    return size + "B";
                if (size < Math.pow(num, 2))
                    return (size / num).toFixed(2) + "KB/S"; //kb
                if (size < Math.pow(num, 3))
                    return (size / Math.pow(num, 2)).toFixed(2) + "MB/S"; //M
                if (size < Math.pow(num, 4))
                    return (size / Math.pow(num, 3)).toFixed(2) + "G/S"; //G
                return (size / Math.pow(num, 4)).toFixed(2) + "T/S"; //T
            },
            //获取get参数
            getQueryVariable(variable) {
                let query = window.location.search.substring(1);
                let vars = query.split("&");
                for (let i = 0; i < vars.length; i++) {
                    let pair = vars[i].split("=");
                    if (pair[0] === variable) {
                        return pair[1];
                    }
                }
                return false;
            }
        }
    });
</script>
</html>
<style>
    /*ui框架-表单行间距缩小*/
    .el-form-item--mini.el-form-item, .el-form-item--small.el-form-item {
        margin-bottom: 5px;
    }

    .el-form-item {
        margin-bottom: 5px;
    }

    /*自定义*/
    .my-softphone {
        top: 0;
        left: 0;
        height: 3.6rem;
        max-width: 475px;
        /*background-color: rgba(0, 0, 0, .15);*/
        border-radius: 50px;
        padding: 0 5px 0 20px;
    }

    .my-softphone .status {
        height: 2.9rem;
        margin-top: 0.3rem;
        min-width: 30%;
        border-radius: 3px;
        float: left;
    }

    .my-softphone .btn {
        height: 2.9rem;
        min-width: 50%;
        text-align: right;
        float: right;
    }

    .my-softphone .number {
        max-width: 150px;
        overflow: hidden;
    }

    .my-softphone .status .text {
        line-height: 22px;
    }

    .my-softphone .soft-function {
        width: 2rem;
        height: 2.9rem;
        margin-top: 0.3rem;
        margin-right: 1.2rem;

        text-align: center;
        border-radius: 3px;
        float: right;
        cursor: pointer;
    }

    .my-softphone .soft-function:hover {
        background-color: rgba(0, 0, 0, .10);
    }

    .my-softphone .soft-function.disabled {
        cursor: not-allowed;
        color: #acacac !important;
    }

    .my-softphone .soft-function iconpark-icon {
        font-size: 1.6rem;
    }

    .my-softphone .soft-function .text {
        font-size: 1rem;
    }

    .my-softphone .soft-function .soft-function {
        margin: 0 !important;
    }

    .number-card-button {
        width: 100%;
    }

    .config {
        margin-top: 0.5rem;
        max-width: 500px;
    }

    #footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        text-align: center;
        font-size: 0.5rem;
    }

</style>
